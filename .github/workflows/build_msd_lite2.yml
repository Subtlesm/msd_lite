name: 编译 AX3600 专用 msd_lite (修复版)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1. 拉取仓库
      uses: actions/checkout@v4

    - name: 2. 安装编译器和 CMake
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu build-essential cmake

    - name: 3. 下载 msd_lite 源码
      run: |
        git clone https://github.com/rozhuk-im/msd_lite.git

    - name: 4. 针对 IPQ8071A 编译 (修复报错)
      run: |
        cd msd_lite
        mkdir build
        cd build
        
        # 核心修复说明：
        # 1. CMAKE_SYSTEM_NAME=Linux: 明确告诉 CMake 这是一个 Linux 交叉编译，防止查找宿主机库。
        # 2. CMAKE_C_FLAGS: 移除了 -static，只保留优化参数，防止干扰编译器特性检测。
        # 3. CMAKE_EXE_LINKER_FLAGS: 在这里加 -static，确保最终生成的文件是静态的。
        # 4. -pthread: 显式添加线程库支持。
        
        cmake -DCMAKE_SYSTEM_NAME=Linux \
              -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
              -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
              -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
              -DCMAKE_C_FLAGS="-O3 -mcpu=cortex-a53 -Wall -D_GNU_SOURCE -pthread" \
              -DCMAKE_EXE_LINKER_FLAGS="-static -pthread" \
              -DCMAKE_BUILD_TYPE=Release ..
        
        # 编译
        make -j$(nproc)

    - name: 5. 验证与打包
      run: |
        # 查找生成的文件
        # 注意：cmake 有时会把二进制文件生成在 src 目录，有时在 build 根目录
        TARGET_FILE=$(find . -type f -name "msd_lite" | head -n 1)
        
        if [ -z "$TARGET_FILE" ]; then
          echo "❌ 编译失败，未找到 msd_lite 文件"
          exit 1
        fi
        
        echo "✅ 找到文件：$TARGET_FILE"
        
        # 验证是否为静态链接 (Static Linked)
        file "$TARGET_FILE"
        
        # 瘦身
        aarch64-linux-gnu-strip "$TARGET_FILE"
        
        # 复制出来
        cp "$TARGET_FILE" ./msd_lite_ax3600

    - name: 6. 上传成品
      uses: actions/upload-artifact@v4
      with:
        name: msd_lite-ax3600-fixed
        path: msd_lite/build/msd_lite_ax3600
