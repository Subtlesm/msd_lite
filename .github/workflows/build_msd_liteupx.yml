name: ç¼–è¯‘ AX3600 æé™ç˜¦èº«ç‰ˆ msd_lite (UPX)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1. æ‹‰å–ä»“åº“
      uses: actions/checkout@v4

    - name: 2. å®‰è£…ç¯å¢ƒ (ç¼–è¯‘å™¨ + CMake + UPX)
      run: |
        sudo apt-get update
        # å¢åŠ å®‰è£… upx-ucl
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu build-essential cmake upx-ucl

    - name: 3. ä¸‹è½½æºç 
      run: |
        git clone --recursive https://github.com/rozhuk-im/msd_lite.git

    - name: 4. ç”Ÿæˆäº¤å‰ç¼–è¯‘é…ç½®
      run: |
        cd msd_lite
        cat <<EOF > toolchain.cmake
        set(CMAKE_SYSTEM_NAME Linux)
        set(CMAKE_SYSTEM_PROCESSOR aarch64)
        set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
        set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)
        set(CMAKE_FIND_ROOT_PATH /usr/aarch64-linux-gnu)
        set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
        set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
        set(PTHREAD_LIBRARY pthread CACHE STRING "Forced pthread" FORCE)
        set(CMAKE_USE_PTHREADS_INIT 1)
        EOF

    - name: 5. ç¼–è¯‘ (æ”¹ä¸ºä½“ç§¯ä¼˜å…ˆ)
      run: |
        cd msd_lite
        mkdir build
        cd build
        
        # ä¼˜åŒ–å‚æ•°å˜æ›´ï¼š
        # -Os: é’ˆå¯¹ä½“ç§¯ä¼˜åŒ–ï¼Œè€Œä¸æ˜¯é€Ÿåº¦
        # -flto: é“¾æ¥æ—¶ä¼˜åŒ–ï¼Œå‰”é™¤æ— ç”¨ä»£ç 
        # -Wl,--gc-sections: è¿›ä¸€æ­¥å‰”é™¤æœªä½¿ç”¨çš„æ®µ
        cmake -DCMAKE_TOOLCHAIN_FILE=../toolchain.cmake \
              -DCMAKE_C_FLAGS="-Os -flto -mcpu=cortex-a53 -ffunction-sections -fdata-sections -Wall -D_GNU_SOURCE -static" \
              -DCMAKE_EXE_LINKER_FLAGS="-static -flto -Wl,--gc-sections" \
              -DCMAKE_BUILD_TYPE=MinSizeRel ..
        
        make -j$(nproc)

    - name: 6. éªŒè¯ã€ç˜¦èº«ä¸å‹ç¼© (æ ¸å¿ƒæ­¥éª¤)
      run: |
        TARGET_FILE=$(find msd_lite/build -name "msd_lite" -type f | head -n 1)
        
        if [ -z "$TARGET_FILE" ]; then
          echo "âŒ æœªæ‰¾åˆ°æ–‡ä»¶"
          exit 1
        fi
        
        echo "â¬‡ï¸ åŸå§‹å¤§å°ï¼š"
        ls -lh "$TARGET_FILE"
        
        # 1. å‰¥ç¦»ç¬¦å· (Strip)
        aarch64-linux-gnu-strip --strip-all "$TARGET_FILE"
        echo "â¬‡ï¸ Strip åå¤§å°ï¼š"
        ls -lh "$TARGET_FILE"
        
        # 2. UPX æè‡´å‹ç¼©
        # --best: æœ€é«˜å‹ç¼©ç‡
        # --lzma: ä½¿ç”¨ LZMA ç®—æ³• (å‹ç¼©ç‡æœ€é«˜ï¼Œè§£å‹ç¨æ…¢ä½†å¯¹äº 500k æ–‡ä»¶æ— æ„ŸçŸ¥)
        upx --best --lzma "$TARGET_FILE"
        
        echo "ğŸ‰ UPX å‹ç¼©åæœ€ç»ˆå¤§å°ï¼š"
        ls -lh "$TARGET_FILE"
        
        cp "$TARGET_FILE" ./msd_lite_tiny

    - name: 7. ä¸Šä¼ æˆå“
      uses: actions/upload-artifact@v4
      with:
        name: msd_lite-ax3600-tiny
        path: ./msd_lite_tiny
