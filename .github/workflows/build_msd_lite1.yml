name: 编译 AX3600 专用 msd_lite (CMake终极版)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1. 拉取仓库
      uses: actions/checkout@v4

    - name: 2. 安装编译器和 CMake
      run: |
        sudo apt-get update
        # 安装 aarch64 交叉编译器和 cmake
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu build-essential cmake

    - name: 3. 下载 msd_lite 源码
      run: |
        git clone https://github.com/rozhuk-im/msd_lite.git

    - name: 4. 针对 IPQ8071A 编译 (关键修改)
      run: |
        cd msd_lite
        mkdir build
        cd build
        
        # 核心配置：
        # -mcpu=cortex-a53: 针对 AX3600 CPU 优化指令集
        # -static: 静态链接，确保在 OpenWrt 18.06 上能跑
        cmake -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc \
              -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++ \
              -DCMAKE_C_FLAGS="-O3 -static -mcpu=cortex-a53 -Wall -D_GNU_SOURCE" \
              -DCMAKE_EXE_LINKER_FLAGS="-static" \
              -DCMAKE_BUILD_TYPE=Release ..
        
        # 编译
        make -j$(nproc)

    - name: 5. 验证与打包
      run: |
        # 查找生成的文件
        TARGET_FILE=$(find . -name "msd_lite" -type f | head -n 1)
        
        if [ -z "$TARGET_FILE" ]; then
          echo "❌ 编译失败，未找到文件"
          exit 1
        fi
        
        echo "✅ 编译成功：$TARGET_FILE"
        # 瘦身，减小体积
        aarch64-linux-gnu-strip "$TARGET_FILE"
        # 复制出来
        cp "$TARGET_FILE" ./msd_lite_ax3600

    - name: 6. 上传成品
      uses: actions/upload-artifact@v4
      with:
        name: msd_lite-ax3600-optimized
        path: msd_lite/build/msd_lite_ax3600
